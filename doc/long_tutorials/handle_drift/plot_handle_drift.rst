
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "long_tutorials/handle_drift/plot_handle_drift.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_long_tutorials_handle_drift_plot_handle_drift.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_long_tutorials_handle_drift_plot_handle_drift.py:


Handle motion/drift with spikeinterface NEW
===========================================

Spikeinterface offers a very flexible framework to handle drift as a preprocessing step.
If you want to know more, please read the
:ref:`motion_correction` section of the documentation.

Here is a short demo on how to handle drift using the high-level function
:py:func:`~spikeinterface.preprocessing.correct_motion()`.

This function takes a preprocessed recording as input and then internally runs
several steps (it can be slow!) and returns a lazy
recording that interpolates the traces on-the-fly to compensate for the motion.

Internally this function runs the following steps:

| **1.** ``localize_peaks()``
| **2.** ``select_peaks()`` (optional)
| **3.** ``estimate_motion()``
| **4.** ``interpolate_motion()``

All these sub-steps can be run with different methods and have many parameters.
The high-level function suggests 3 pre-difined "presets".

.. GENERATED FROM PYTHON SOURCE LINES 28-29

FIRST WE IMPORT AND # We will use GENERATE RECORDINGS

.. GENERATED FROM PYTHON SOURCE LINES 29-36

.. code-block:: Python


    from pathlib import Path
    import matplotlib.pyplot as plt
    import numpy as np
    import shutil
    import spikeinterface.full as si








.. GENERATED FROM PYTHON SOURCE LINES 37-52

.. code-block:: Python

    from spikeinterface.extractors import toy_example
    from spikeinterface.generation.drifting_generator import generate_drifting_recording

    # TODO: add a note that it must be run in a if __name__ == "__main__" block.
    # TODO: is there currently any way to compute accuracy of method based on
    # drift-corrected vs. original static recording?

    _, raw_rec, _ = generate_drifting_recording(
        num_units=300,
        duration=1000,
        generate_sorting_kwargs=dict(firing_rates=(15, 25), refractory_period_ms=4.0),
        seed=42,
    )
    print(raw_rec)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    InjectDriftingTemplatesRecording: 128 channels - 30.0kHz - 1 segments - 30,000,000 samples 
                                      1,000.00s (16.67 minutes) - float32 dtype - 14.31 GiB




.. GENERATED FROM PYTHON SOURCE LINES 53-56

We preprocess the recording with bandpass filter and a common median reference.
Note, that it is better to not whiten the recording before motion estimation
to get a better estimate of peak locations!

.. GENERATED FROM PYTHON SOURCE LINES 56-67

.. code-block:: Python


    def preprocess_chain(rec):
        rec = si.bandpass_filter(rec, freq_min=300.0, freq_max=6000.0)
        rec = si.common_reference(rec, reference="global", operator="median")
        return rec


    rec = preprocess_chain(raw_rec)

    job_kwargs = dict(n_jobs=40, chunk_duration="1s", progress_bar=True)








.. GENERATED FROM PYTHON SOURCE LINES 68-77

Run motion correction with one function!
----------------------------------------

Correcting for drift is easy! You just need to run a single function.
We will try this function with 3 presets.

Internally a preset is a dictionary of dictionaries containing all parameters for every steps.

Here we also save the motion correction results into a folder to be able to load them later.

.. GENERATED FROM PYTHON SOURCE LINES 77-84

.. code-block:: Python


    # internally, we can explore a preset like this
    # every parameter can be overwritten at runtime
    from spikeinterface.preprocessing.motion import motion_options_preset

    print(motion_options_preset["kilosort_like"])





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    {'doc': 'Mimic the drift correction of kilosort (grid_convolution + iterative_template)', 'detect_kwargs': {'method': 'locally_exclusive', 'peak_sign': 'neg', 'detect_threshold': 8.0, 'exclude_sweep_ms': 0.1, 'radius_um': 50}, 'select_kwargs': {}, 'localize_peaks_kwargs': {'method': 'grid_convolution', 'radius_um': 40.0, 'upsampling_um': 5.0, 'weight_method': {'mode': 'gaussian_2d', 'sigma_list_um': array([ 5., 10., 15., 20., 25.])}, 'sigma_ms': 0.25, 'margin_um': 30.0, 'prototype': None, 'percentile': 5.0}, 'estimate_motion_kwargs': {'method': 'iterative_template', 'bin_duration_s': 2.0, 'rigid': False, 'win_step_um': 50.0, 'win_sigma_um': 150.0, 'margin_um': 0, 'win_shape': 'rect'}, 'interpolate_motion_kwargs': {'direction': 1, 'border_mode': 'force_extrapolate', 'spatial_interpolation_method': 'kriging', 'sigma_um': 20.0, 'p': 2}}




.. GENERATED FROM PYTHON SOURCE LINES 85-86

lets try theses 3 presets

.. GENERATED FROM PYTHON SOURCE LINES 86-89

.. code-block:: Python

    some_presets = ("rigid_fast", "kilosort_like", "nonrigid_accurate")
    results = {preset: {} for preset in some_presets}  # TODO: RENAME VAR








.. GENERATED FROM PYTHON SOURCE LINES 90-91

and compute motion with 3 presets

.. GENERATED FROM PYTHON SOURCE LINES 91-100

.. code-block:: Python


    for preset in some_presets:
        print("Computing with", preset)

        recording_corrected, motion_info = si.correct_motion(  # TODO: RECORDING_CORRECTED UNUSED
            rec, preset=preset,  output_motion_info=True, **job_kwargs
        )
        results[preset]["motion_info"] = motion_info





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Computing with rigid_fast
    detect and localize:   0%|          | 0/1000 [00:00<?, ?it/s]    detect and localize:   5%|▌         | 50/1000 [00:00<00:02, 390.11it/s]    detect and localize:   9%|▉         | 90/1000 [00:07<01:35,  9.52it/s]     detect and localize:  11%|█         | 107/1000 [00:08<01:14, 11.97it/s]    detect and localize:  12%|█▏        | 119/1000 [00:12<02:02,  7.21it/s]    detect and localize:  13%|█▎        | 127/1000 [00:13<01:52,  7.79it/s]    detect and localize:  13%|█▎        | 134/1000 [00:13<01:41,  8.49it/s]    detect and localize:  15%|█▌        | 154/1000 [00:13<01:05, 12.83it/s]    detect and localize:  16%|█▌        | 159/1000 [00:19<03:03,  4.58it/s]    detect and localize:  16%|█▋        | 165/1000 [00:20<02:37,  5.30it/s]    detect and localize:  20%|█▉        | 196/1000 [00:23<01:52,  7.17it/s]    detect and localize:  20%|█▉        | 199/1000 [00:25<02:19,  5.73it/s]    detect and localize:  20%|██        | 203/1000 [00:25<02:15,  5.86it/s]    detect and localize:  20%|██        | 205/1000 [00:26<02:14,  5.91it/s]    detect and localize:  23%|██▎       | 226/1000 [00:26<01:02, 12.36it/s]    detect and localize:  24%|██▎       | 235/1000 [00:27<01:02, 12.16it/s]    detect and localize:  24%|██▍       | 239/1000 [00:32<03:09,  4.02it/s]    detect and localize:  24%|██▍       | 242/1000 [00:33<03:33,  3.55it/s]    detect and localize:  25%|██▍       | 247/1000 [00:34<02:58,  4.21it/s]    detect and localize:  25%|██▌       | 250/1000 [00:34<02:32,  4.91it/s]    detect and localize:  26%|██▌       | 257/1000 [00:36<02:50,  4.36it/s]    detect and localize:  27%|██▋       | 269/1000 [00:36<01:36,  7.55it/s]    detect and localize:  28%|██▊       | 276/1000 [00:39<02:24,  4.99it/s]    detect and localize:  28%|██▊       | 278/1000 [00:40<02:50,  4.23it/s]    detect and localize:  28%|██▊       | 280/1000 [00:41<03:33,  3.36it/s]    detect and localize:  28%|██▊       | 281/1000 [00:42<04:26,  2.69it/s]    detect and localize:  28%|██▊       | 282/1000 [00:43<04:16,  2.80it/s]    detect and localize:  29%|██▉       | 291/1000 [00:43<01:58,  5.99it/s]    detect and localize:  29%|██▉       | 293/1000 [00:43<02:10,  5.42it/s]    detect and localize:  30%|██▉       | 295/1000 [00:44<01:59,  5.88it/s]    detect and localize:  30%|███       | 300/1000 [00:44<01:28,  7.94it/s]    detect and localize:  31%|███       | 307/1000 [00:45<01:15,  9.19it/s]    detect and localize:  31%|███▏      | 314/1000 [00:46<01:22,  8.32it/s]    detect and localize:  32%|███▏      | 317/1000 [00:46<01:23,  8.13it/s]    detect and localize:  32%|███▏      | 318/1000 [00:46<01:48,  6.30it/s]    detect and localize:  32%|███▏      | 319/1000 [00:49<04:56,  2.30it/s]    detect and localize:  32%|███▏      | 322/1000 [00:50<03:45,  3.01it/s]    detect and localize:  32%|███▏      | 324/1000 [00:50<04:04,  2.76it/s]    detect and localize:  33%|███▎      | 327/1000 [00:52<04:09,  2.70it/s]    detect and localize:  33%|███▎      | 334/1000 [00:52<02:12,  5.02it/s]    detect and localize:  35%|███▌      | 353/1000 [00:52<00:55, 11.63it/s]    detect and localize:  36%|███▌      | 355/1000 [00:53<01:11,  8.97it/s]    detect and localize:  36%|███▌      | 357/1000 [00:55<02:01,  5.27it/s]    detect and localize:  36%|███▌      | 359/1000 [00:55<02:05,  5.09it/s]    detect and localize:  36%|███▌      | 360/1000 [00:56<02:29,  4.27it/s]    detect and localize:  36%|███▌      | 362/1000 [00:56<02:20,  4.54it/s]    detect and localize:  36%|███▋      | 364/1000 [00:57<02:19,  4.57it/s]    detect and localize:  37%|███▋      | 367/1000 [00:57<02:13,  4.73it/s]    detect and localize:  37%|███▋      | 369/1000 [00:58<02:09,  4.87it/s]    detect and localize:  37%|███▋      | 374/1000 [00:58<01:43,  6.03it/s]    detect and localize:  38%|███▊      | 379/1000 [00:58<01:10,  8.79it/s]    detect and localize:  39%|███▉      | 393/1000 [00:59<00:32, 18.55it/s]    detect and localize:  40%|███▉      | 396/1000 [01:00<01:12,  8.28it/s]    detect and localize:  40%|███▉      | 399/1000 [01:02<01:58,  5.09it/s]    detect and localize:  40%|████      | 401/1000 [01:03<02:19,  4.31it/s]    detect and localize:  40%|████      | 403/1000 [01:03<02:17,  4.34it/s]    detect and localize:  41%|████      | 407/1000 [01:03<01:52,  5.27it/s]    detect and localize:  41%|████      | 409/1000 [01:05<02:47,  3.54it/s]    detect and localize:  42%|████▏     | 417/1000 [01:05<01:23,  7.01it/s]    detect and localize:  42%|████▏     | 420/1000 [01:05<01:29,  6.50it/s]    detect and localize:  44%|████▎     | 435/1000 [01:07<01:10,  7.98it/s]    detect and localize:  44%|████▎     | 437/1000 [01:07<01:07,  8.39it/s]    detect and localize:  44%|████▍     | 439/1000 [01:10<02:28,  3.77it/s]    detect and localize:  44%|████▍     | 442/1000 [01:10<02:26,  3.80it/s]    detect and localize:  44%|████▍     | 444/1000 [01:11<02:06,  4.40it/s]    detect and localize:  45%|████▍     | 447/1000 [01:11<02:04,  4.45it/s]    detect and localize:  45%|████▍     | 449/1000 [01:12<02:04,  4.43it/s]    detect and localize:  45%|████▌     | 451/1000 [01:12<01:58,  4.63it/s]    detect and localize:  46%|████▌     | 457/1000 [01:13<01:50,  4.91it/s]    detect and localize:  47%|████▋     | 469/1000 [01:13<00:48, 10.96it/s]    detect and localize:  47%|████▋     | 473/1000 [01:14<00:49, 10.64it/s]    detect and localize:  48%|████▊     | 477/1000 [01:15<01:06,  7.85it/s]    detect and localize:  48%|████▊     | 479/1000 [01:17<02:38,  3.30it/s]    detect and localize:  48%|████▊     | 482/1000 [01:18<02:24,  3.59it/s]    detect and localize:  48%|████▊     | 484/1000 [01:18<02:15,  3.80it/s]    detect and localize:  49%|████▉     | 492/1000 [01:20<01:52,  4.51it/s]    detect and localize:  49%|████▉     | 494/1000 [01:20<01:41,  4.97it/s]    detect and localize:  50%|█████     | 502/1000 [01:21<01:10,  7.08it/s]    detect and localize:  51%|█████     | 511/1000 [01:21<00:43, 11.26it/s]    detect and localize:  51%|█████▏    | 514/1000 [01:22<01:13,  6.65it/s]    detect and localize:  52%|█████▏    | 519/1000 [01:25<02:07,  3.77it/s]    detect and localize:  52%|█████▏    | 524/1000 [01:25<01:46,  4.49it/s]    detect and localize:  53%|█████▎    | 529/1000 [01:26<01:20,  5.83it/s]    detect and localize:  53%|█████▎    | 534/1000 [01:26<01:10,  6.64it/s]    detect and localize:  54%|█████▎    | 537/1000 [01:26<01:02,  7.44it/s]    detect and localize:  54%|█████▍    | 539/1000 [01:27<01:02,  7.34it/s]    detect and localize:  54%|█████▍    | 542/1000 [01:27<01:16,  6.01it/s]    detect and localize:  54%|█████▍    | 543/1000 [01:28<01:12,  6.28it/s]    detect and localize:  55%|█████▍    | 549/1000 [01:29<01:15,  5.96it/s]    detect and localize:  56%|█████▌    | 555/1000 [01:29<00:53,  8.31it/s]    detect and localize:  56%|█████▌    | 559/1000 [01:31<01:44,  4.23it/s]    detect and localize:  56%|█████▌    | 561/1000 [01:32<01:44,  4.18it/s]    detect and localize:  56%|█████▋    | 565/1000 [01:32<01:36,  4.53it/s]    detect and localize:  57%|█████▋    | 567/1000 [01:33<02:02,  3.53it/s]    detect and localize:  58%|█████▊    | 576/1000 [01:34<01:11,  5.92it/s]    detect and localize:  58%|█████▊    | 584/1000 [01:34<00:44,  9.30it/s]    detect and localize:  59%|█████▊    | 587/1000 [01:35<00:56,  7.31it/s]    detect and localize:  60%|█████▉    | 595/1000 [01:36<00:58,  6.90it/s]    detect and localize:  60%|█████▉    | 599/1000 [01:37<01:04,  6.20it/s]    detect and localize:  60%|██████    | 601/1000 [01:38<01:14,  5.37it/s]    detect and localize:  60%|██████    | 602/1000 [01:40<02:19,  2.85it/s]    detect and localize:  61%|██████    | 607/1000 [01:40<01:30,  4.35it/s]    detect and localize:  61%|██████▏   | 614/1000 [01:41<01:08,  5.61it/s]    detect and localize:  62%|██████▏   | 622/1000 [01:41<00:46,  8.21it/s]    detect and localize:  63%|██████▎   | 629/1000 [01:41<00:34, 10.83it/s]    detect and localize:  63%|██████▎   | 634/1000 [01:42<00:28, 12.92it/s]    detect and localize:  64%|██████▎   | 637/1000 [01:44<01:06,  5.46it/s]    detect and localize:  64%|██████▍   | 639/1000 [01:46<01:47,  3.36it/s]    detect and localize:  64%|██████▍   | 642/1000 [01:46<01:36,  3.71it/s]    detect and localize:  65%|██████▍   | 647/1000 [01:47<01:22,  4.26it/s]    detect and localize:  65%|██████▍   | 648/1000 [01:47<01:25,  4.14it/s]    detect and localize:  65%|██████▌   | 652/1000 [01:47<01:01,  5.69it/s]    detect and localize:  65%|██████▌   | 654/1000 [01:48<01:23,  4.14it/s]    detect and localize:  66%|██████▌   | 657/1000 [01:49<01:17,  4.42it/s]    detect and localize:  67%|██████▋   | 672/1000 [01:49<00:30, 10.60it/s]    detect and localize:  68%|██████▊   | 677/1000 [01:52<01:09,  4.62it/s]    detect and localize:  68%|██████▊   | 679/1000 [01:53<01:04,  5.00it/s]    detect and localize:  68%|██████▊   | 682/1000 [01:53<01:08,  4.67it/s]    detect and localize:  68%|██████▊   | 683/1000 [01:54<01:07,  4.72it/s]    detect and localize:  68%|██████▊   | 684/1000 [01:55<01:47,  2.95it/s]    detect and localize:  69%|██████▊   | 687/1000 [01:55<01:18,  3.99it/s]    detect and localize:  69%|██████▉   | 689/1000 [01:56<01:17,  4.00it/s]    detect and localize:  69%|██████▉   | 692/1000 [01:56<00:57,  5.35it/s]    detect and localize:  69%|██████▉   | 694/1000 [01:56<00:56,  5.46it/s]    detect and localize:  70%|███████   | 702/1000 [01:57<00:32,  9.31it/s]    detect and localize:  71%|███████   | 707/1000 [01:58<00:39,  7.41it/s]    detect and localize:  72%|███████▏  | 717/1000 [01:58<00:23, 12.01it/s]    detect and localize:  72%|███████▏  | 719/1000 [02:00<01:04,  4.34it/s]    detect and localize:  72%|███████▏  | 724/1000 [02:02<01:04,  4.28it/s]    detect and localize:  73%|███████▎  | 726/1000 [02:02<01:01,  4.47it/s]    detect and localize:  73%|███████▎  | 729/1000 [02:02<00:49,  5.52it/s]    detect and localize:  74%|███████▎  | 737/1000 [02:04<00:55,  4.74it/s]    detect and localize:  74%|███████▍  | 738/1000 [02:04<00:54,  4.85it/s]    detect and localize:  75%|███████▍  | 747/1000 [02:05<00:36,  6.95it/s]    detect and localize:  76%|███████▌  | 756/1000 [02:06<00:34,  7.17it/s]    detect and localize:  76%|███████▌  | 759/1000 [02:06<00:30,  7.96it/s]    detect and localize:  76%|███████▌  | 761/1000 [02:09<01:10,  3.40it/s]    detect and localize:  76%|███████▌  | 762/1000 [02:10<01:25,  2.79it/s]    detect and localize:  77%|███████▋  | 767/1000 [02:10<00:53,  4.39it/s]    detect and localize:  77%|███████▋  | 774/1000 [02:11<00:44,  5.09it/s]    detect and localize:  79%|███████▉  | 792/1000 [02:12<00:22,  9.10it/s]    detect and localize:  79%|███████▉  | 794/1000 [02:13<00:29,  7.09it/s]    detect and localize:  80%|███████▉  | 797/1000 [02:14<00:33,  5.99it/s]    detect and localize:  80%|███████▉  | 799/1000 [02:14<00:32,  6.24it/s]    detect and localize:  80%|████████  | 804/1000 [02:17<00:56,  3.47it/s]    detect and localize:  81%|████████  | 807/1000 [02:18<00:55,  3.45it/s]    detect and localize:  82%|████████▏ | 822/1000 [02:19<00:28,  6.35it/s]    detect and localize:  82%|████████▏ | 823/1000 [02:19<00:28,  6.13it/s]    detect and localize:  84%|████████▍ | 839/1000 [02:19<00:12, 12.74it/s]    detect and localize:  84%|████████▍ | 843/1000 [02:24<00:42,  3.72it/s]    detect and localize:  85%|████████▍ | 847/1000 [02:25<00:39,  3.88it/s]    detect and localize:  86%|████████▌ | 855/1000 [02:25<00:25,  5.77it/s]    detect and localize:  86%|████████▌ | 859/1000 [02:26<00:26,  5.41it/s]    detect and localize:  86%|████████▋ | 864/1000 [02:27<00:21,  6.24it/s]    detect and localize:  88%|████████▊ | 879/1000 [02:28<00:14,  8.57it/s]    detect and localize:  88%|████████▊ | 882/1000 [02:29<00:19,  5.93it/s]    detect and localize:  88%|████████▊ | 884/1000 [02:32<00:31,  3.64it/s]    detect and localize:  89%|████████▊ | 887/1000 [02:33<00:35,  3.21it/s]    detect and localize:  89%|████████▉ | 894/1000 [02:33<00:21,  4.84it/s]    detect and localize:  91%|█████████ | 907/1000 [02:34<00:12,  7.67it/s]    detect and localize:  92%|█████████▏| 919/1000 [02:35<00:08,  9.24it/s]    detect and localize:  92%|█████████▏| 922/1000 [02:37<00:12,  6.45it/s]    detect and localize:  92%|█████████▏| 924/1000 [02:37<00:10,  6.91it/s]    detect and localize:  93%|█████████▎| 926/1000 [02:37<00:12,  5.75it/s]    detect and localize:  93%|█████████▎| 927/1000 [02:39<00:19,  3.76it/s]    detect and localize:  93%|█████████▎| 928/1000 [02:39<00:20,  3.49it/s]    detect and localize:  93%|█████████▎| 934/1000 [02:41<00:20,  3.23it/s]    detect and localize:  95%|█████████▌| 954/1000 [02:41<00:04,  9.71it/s]    detect and localize:  96%|█████████▌| 962/1000 [02:42<00:04,  9.16it/s]    detect and localize:  96%|█████████▋| 965/1000 [02:44<00:05,  6.69it/s]    detect and localize:  97%|█████████▋| 967/1000 [02:46<00:08,  3.68it/s]    detect and localize:  99%|█████████▉| 994/1000 [02:46<00:00, 11.18it/s]    detect and localize: 100%|██████████| 1000/1000 [02:47<00:00,  5.98it/s]
    Computing with kilosort_like
    detect and localize:   0%|          | 0/1000 [00:00<?, ?it/s]    detect and localize:   5%|▍         | 48/1000 [00:00<00:02, 349.51it/s]    detect and localize:   8%|▊         | 83/1000 [00:08<01:48,  8.43it/s]     detect and localize:  10%|▉         | 99/1000 [00:08<01:28, 10.22it/s]    detect and localize:  12%|█▏        | 116/1000 [00:13<02:07,  6.95it/s]    detect and localize:  12%|█▏        | 122/1000 [00:14<02:05,  6.97it/s]    detect and localize:  13%|█▎        | 127/1000 [00:14<01:52,  7.79it/s]    detect and localize:  13%|█▎        | 131/1000 [00:14<01:48,  7.98it/s]    detect and localize:  15%|█▌        | 152/1000 [00:14<00:56, 14.88it/s]    detect and localize:  16%|█▌        | 160/1000 [00:20<02:48,  4.98it/s]    detect and localize:  17%|█▋        | 166/1000 [00:20<02:25,  5.75it/s]    detect and localize:  18%|█▊        | 183/1000 [00:21<01:27,  9.32it/s]    detect and localize:  20%|█▉        | 196/1000 [00:24<02:06,  6.36it/s]    detect and localize:  20%|██        | 200/1000 [00:26<02:46,  4.80it/s]    detect and localize:  20%|██        | 203/1000 [00:27<02:37,  5.05it/s]    detect and localize:  21%|██        | 207/1000 [00:27<02:15,  5.85it/s]    detect and localize:  24%|██▎       | 236/1000 [00:30<01:42,  7.47it/s]    detect and localize:  24%|██▍       | 238/1000 [00:31<01:50,  6.91it/s]    detect and localize:  24%|██▍       | 241/1000 [00:31<01:58,  6.43it/s]    detect and localize:  24%|██▍       | 242/1000 [00:32<02:23,  5.29it/s]    detect and localize:  24%|██▍       | 244/1000 [00:33<02:26,  5.17it/s]    detect and localize:  25%|██▌       | 252/1000 [00:33<01:38,  7.57it/s]    detect and localize:  26%|██▌       | 262/1000 [00:33<00:59, 12.36it/s]    detect and localize:  28%|██▊       | 276/1000 [00:35<01:23,  8.69it/s]    detect and localize:  28%|██▊       | 279/1000 [00:37<02:02,  5.89it/s]    detect and localize:  28%|██▊       | 281/1000 [00:37<02:01,  5.94it/s]    detect and localize:  28%|██▊       | 283/1000 [00:38<02:18,  5.18it/s]    detect and localize:  28%|██▊       | 285/1000 [00:39<02:19,  5.12it/s]    detect and localize:  29%|██▊       | 287/1000 [00:39<02:08,  5.54it/s]    detect and localize:  29%|██▉       | 291/1000 [00:39<01:56,  6.06it/s]    detect and localize:  31%|███       | 312/1000 [00:39<00:35, 19.57it/s]    detect and localize:  32%|███▏      | 317/1000 [00:42<01:30,  7.54it/s]    detect and localize:  32%|███▏      | 321/1000 [00:44<02:25,  4.65it/s]    detect and localize:  32%|███▏      | 324/1000 [00:45<02:30,  4.49it/s]    detect and localize:  33%|███▎      | 334/1000 [00:45<01:28,  7.48it/s]    detect and localize:  34%|███▎      | 337/1000 [00:45<01:19,  8.31it/s]    detect and localize:  34%|███▍      | 340/1000 [00:45<01:11,  9.25it/s]    detect and localize:  34%|███▍      | 343/1000 [00:46<01:00, 10.78it/s]    detect and localize:  35%|███▍      | 346/1000 [00:46<01:07,  9.65it/s]    detect and localize:  36%|███▌      | 356/1000 [00:48<01:25,  7.55it/s]    detect and localize:  36%|███▌      | 358/1000 [00:49<02:14,  4.76it/s]    detect and localize:  36%|███▌      | 360/1000 [00:51<03:11,  3.34it/s]    detect and localize:  36%|███▌      | 362/1000 [00:51<02:45,  3.85it/s]    detect and localize:  36%|███▋      | 365/1000 [00:51<02:19,  4.55it/s]    detect and localize:  37%|███▋      | 369/1000 [00:51<01:41,  6.20it/s]    detect and localize:  38%|███▊      | 376/1000 [00:51<00:59, 10.48it/s]    detect and localize:  38%|███▊      | 382/1000 [00:52<00:43, 14.17it/s]    detect and localize:  38%|███▊      | 385/1000 [00:52<00:41, 14.86it/s]    detect and localize:  39%|███▉      | 388/1000 [00:52<00:36, 16.61it/s]    detect and localize:  39%|███▉      | 392/1000 [00:52<00:45, 13.22it/s]    detect and localize:  40%|███▉      | 396/1000 [00:54<01:52,  5.35it/s]    detect and localize:  40%|███▉      | 398/1000 [00:56<03:21,  2.99it/s]    detect and localize:  40%|████      | 400/1000 [00:57<03:42,  2.70it/s]    detect and localize:  40%|████      | 402/1000 [00:57<03:04,  3.24it/s]    detect and localize:  40%|████      | 404/1000 [00:58<02:40,  3.72it/s]    detect and localize:  41%|████      | 408/1000 [00:58<01:52,  5.28it/s]    detect and localize:  42%|████▎     | 425/1000 [00:58<00:34, 16.72it/s]    detect and localize:  43%|████▎     | 430/1000 [00:59<00:46, 12.34it/s]    detect and localize:  44%|████▎     | 436/1000 [01:00<01:06,  8.44it/s]    detect and localize:  44%|████▍     | 439/1000 [01:04<02:53,  3.23it/s]    detect and localize:  44%|████▍     | 444/1000 [01:04<02:08,  4.34it/s]    detect and localize:  47%|████▋     | 466/1000 [01:04<00:45, 11.67it/s]    detect and localize:  48%|████▊     | 475/1000 [01:04<00:37, 14.04it/s]    detect and localize:  48%|████▊     | 482/1000 [01:10<02:10,  3.98it/s]    detect and localize:  49%|████▊     | 487/1000 [01:10<01:46,  4.82it/s]    detect and localize:  50%|█████     | 502/1000 [01:11<00:59,  8.40it/s]    detect and localize:  51%|█████     | 508/1000 [01:11<00:48, 10.13it/s]    detect and localize:  52%|█████▏    | 516/1000 [01:12<00:47, 10.19it/s]    detect and localize:  52%|█████▏    | 521/1000 [01:17<02:16,  3.50it/s]    detect and localize:  52%|█████▏    | 524/1000 [01:17<02:06,  3.76it/s]    detect and localize:  53%|█████▎    | 532/1000 [01:17<01:22,  5.68it/s]    detect and localize:  54%|█████▎    | 537/1000 [01:17<01:04,  7.15it/s]    detect and localize:  54%|█████▍    | 541/1000 [01:18<00:59,  7.66it/s]    detect and localize:  56%|█████▌    | 557/1000 [01:20<01:00,  7.35it/s]    detect and localize:  56%|█████▌    | 560/1000 [01:24<02:07,  3.45it/s]    detect and localize:  56%|█████▌    | 562/1000 [01:24<02:00,  3.65it/s]    detect and localize:  56%|█████▋    | 564/1000 [01:25<01:51,  3.92it/s]    detect and localize:  58%|█████▊    | 579/1000 [01:25<00:46,  9.11it/s]    detect and localize:  58%|█████▊    | 583/1000 [01:25<00:40, 10.29it/s]    detect and localize:  59%|█████▊    | 587/1000 [01:25<00:37, 11.06it/s]    detect and localize:  60%|█████▉    | 597/1000 [01:27<00:52,  7.73it/s]    detect and localize:  60%|██████    | 600/1000 [01:32<02:20,  2.85it/s]    detect and localize:  60%|██████    | 602/1000 [01:32<02:15,  2.93it/s]    detect and localize:  60%|██████    | 604/1000 [01:32<01:58,  3.35it/s]    detect and localize:  61%|██████    | 609/1000 [01:33<01:22,  4.73it/s]    detect and localize:  64%|██████▎   | 635/1000 [01:33<00:22, 16.40it/s]    detect and localize:  64%|██████▍   | 644/1000 [01:40<01:28,  4.04it/s]    detect and localize:  68%|██████▊   | 675/1000 [01:40<00:35,  9.09it/s]    detect and localize:  69%|██████▊   | 687/1000 [01:47<01:11,  4.37it/s]    detect and localize:  72%|███████▏  | 719/1000 [01:52<00:53,  5.23it/s]    detect and localize:  72%|███████▎  | 725/1000 [01:53<00:54,  5.07it/s]    detect and localize:  73%|███████▎  | 730/1000 [01:54<00:51,  5.21it/s]    detect and localize:  74%|███████▍  | 739/1000 [01:54<00:39,  6.57it/s]    detect and localize:  75%|███████▍  | 749/1000 [01:55<00:30,  8.32it/s]    detect and localize:  76%|███████▌  | 759/1000 [01:59<00:51,  4.67it/s]    detect and localize:  76%|███████▌  | 762/1000 [01:59<00:47,  5.01it/s]    detect and localize:  76%|███████▋  | 765/1000 [02:01<00:52,  4.44it/s]    detect and localize:  77%|███████▋  | 767/1000 [02:01<00:55,  4.23it/s]    detect and localize:  77%|███████▋  | 770/1000 [02:02<00:48,  4.79it/s]    detect and localize:  78%|███████▊  | 779/1000 [02:02<00:32,  6.84it/s]    detect and localize:  80%|███████▉  | 799/1000 [02:07<00:39,  5.04it/s]    detect and localize:  80%|████████  | 800/1000 [02:07<00:38,  5.14it/s]    detect and localize:  80%|████████  | 802/1000 [02:08<00:40,  4.89it/s]    detect and localize:  81%|████████  | 809/1000 [02:08<00:28,  6.62it/s]    detect and localize:  82%|████████▏ | 817/1000 [02:08<00:22,  8.29it/s]    detect and localize:  82%|████████▏ | 824/1000 [02:09<00:16, 10.60it/s]    detect and localize:  83%|████████▎ | 827/1000 [02:09<00:15, 10.83it/s]    detect and localize:  83%|████████▎ | 834/1000 [02:09<00:13, 11.91it/s]    detect and localize:  84%|████████▎ | 836/1000 [02:10<00:13, 11.79it/s]    detect and localize:  84%|████████▍ | 838/1000 [02:10<00:15, 10.66it/s]    detect and localize:  84%|████████▍ | 840/1000 [02:14<01:08,  2.34it/s]    detect and localize:  84%|████████▍ | 842/1000 [02:14<00:58,  2.71it/s]    detect and localize:  85%|████████▍ | 847/1000 [02:14<00:34,  4.44it/s]    detect and localize:  85%|████████▌ | 852/1000 [02:14<00:23,  6.21it/s]    detect and localize:  85%|████████▌ | 854/1000 [02:15<00:21,  6.87it/s]    detect and localize:  87%|████████▋ | 867/1000 [02:15<00:08, 15.19it/s]    detect and localize:  87%|████████▋ | 874/1000 [02:17<00:15,  7.92it/s]    detect and localize:  88%|████████▊ | 879/1000 [02:19<00:23,  5.25it/s]    detect and localize:  88%|████████▊ | 881/1000 [02:19<00:23,  5.16it/s]    detect and localize:  88%|████████▊ | 883/1000 [02:21<00:38,  3.03it/s]    detect and localize:  89%|████████▊ | 887/1000 [02:22<00:29,  3.77it/s]    detect and localize:  89%|████████▉ | 893/1000 [02:22<00:20,  5.34it/s]    detect and localize:  90%|████████▉ | 896/1000 [02:22<00:17,  6.05it/s]    detect and localize:  91%|█████████ | 909/1000 [02:22<00:06, 13.30it/s]    detect and localize:  91%|█████████▏| 914/1000 [02:23<00:05, 15.62it/s]    detect and localize:  92%|█████████▏| 919/1000 [02:27<00:20,  3.97it/s]    detect and localize:  92%|█████████▏| 924/1000 [02:27<00:14,  5.13it/s]    detect and localize:  93%|█████████▎| 927/1000 [02:27<00:14,  4.88it/s]    detect and localize:  93%|█████████▎| 930/1000 [02:29<00:16,  4.15it/s]    detect and localize:  93%|█████████▎| 932/1000 [02:29<00:18,  3.66it/s]    detect and localize:  95%|█████████▍| 947/1000 [02:30<00:06,  7.97it/s]    detect and localize:  95%|█████████▍| 949/1000 [02:31<00:07,  7.01it/s]    detect and localize:  96%|█████████▌| 957/1000 [02:31<00:04,  9.36it/s]    detect and localize:  96%|█████████▌| 959/1000 [02:32<00:06,  6.68it/s]    detect and localize:  96%|█████████▌| 961/1000 [02:33<00:08,  4.78it/s]    detect and localize:  96%|█████████▋| 963/1000 [02:35<00:13,  2.65it/s]    detect and localize:  96%|█████████▋| 964/1000 [02:36<00:15,  2.34it/s]    detect and localize:  98%|█████████▊| 979/1000 [02:37<00:02,  7.31it/s]    detect and localize: 100%|█████████▉| 998/1000 [02:37<00:00, 15.16it/s]    detect and localize: 100%|██████████| 1000/1000 [02:37<00:00,  6.34it/s]
    Computing with nonrigid_accurate
    detect and localize:   0%|          | 0/1000 [00:00<?, ?it/s]    detect and localize:   5%|▍         | 49/1000 [00:00<00:02, 398.92it/s]    detect and localize:   5%|▍         | 49/1000 [00:10<00:02, 398.92it/s]    detect and localize:   8%|▊         | 75/1000 [00:30<07:45,  1.99it/s]     detect and localize:   8%|▊         | 76/1000 [00:31<07:48,  1.97it/s]    detect and localize:   9%|▉         | 93/1000 [00:34<06:04,  2.49it/s]    detect and localize:  10%|█         | 103/1000 [00:36<05:10,  2.89it/s]    detect and localize:  10%|█         | 103/1000 [00:50<05:10,  2.89it/s]    detect and localize:  12%|█▏        | 115/1000 [01:01<12:19,  1.20it/s]    detect and localize:  12%|█▏        | 116/1000 [01:02<12:44,  1.16it/s]    detect and localize:  12%|█▏        | 120/1000 [01:04<11:42,  1.25it/s]    detect and localize:  12%|█▎        | 125/1000 [01:05<09:57,  1.46it/s]    detect and localize:  13%|█▎        | 128/1000 [01:07<09:30,  1.53it/s]    detect and localize:  15%|█▌        | 152/1000 [01:07<03:19,  4.25it/s]    detect and localize:  15%|█▌        | 152/1000 [01:20<03:19,  4.25it/s]    detect and localize:  16%|█▌        | 155/1000 [01:31<14:44,  1.05s/it]    detect and localize:  16%|█▌        | 156/1000 [01:32<14:33,  1.03s/it]    detect and localize:  16%|█▌        | 162/1000 [01:34<11:18,  1.23it/s]    detect and localize:  17%|█▋        | 166/1000 [01:36<10:34,  1.31it/s]    detect and localize:  17%|█▋        | 172/1000 [01:36<07:16,  1.90it/s]    detect and localize:  19%|█▉        | 191/1000 [01:37<03:26,  3.91it/s]    detect and localize:  19%|█▉        | 194/1000 [01:40<04:29,  2.99it/s]    detect and localize:  19%|█▉        | 194/1000 [01:50<04:29,  2.99it/s]    detect and localize:  20%|█▉        | 195/1000 [02:02<19:50,  1.48s/it]    detect and localize:  20%|█▉        | 196/1000 [02:03<19:01,  1.42s/it]    detect and localize:  20%|█▉        | 198/1000 [02:03<16:23,  1.23s/it]    detect and localize:  20%|██        | 200/1000 [02:05<15:00,  1.13s/it]    detect and localize:  20%|██        | 202/1000 [02:05<12:00,  1.11it/s]    detect and localize:  20%|██        | 205/1000 [02:07<10:40,  1.24it/s]    detect and localize:  21%|██        | 210/1000 [02:07<06:30,  2.02it/s]    detect and localize:  21%|██        | 212/1000 [02:07<05:43,  2.29it/s]    detect and localize:  21%|██▏       | 213/1000 [02:08<05:11,  2.52it/s]    detect and localize:  21%|██▏       | 214/1000 [02:08<04:40,  2.80it/s]    detect and localize:  22%|██▏       | 218/1000 [02:08<03:22,  3.85it/s]    detect and localize:  23%|██▎       | 234/1000 [02:12<03:01,  4.23it/s]    detect and localize:  24%|██▎       | 235/1000 [02:33<18:54,  1.48s/it]    detect and localize:  24%|██▎       | 236/1000 [02:33<17:36,  1.38s/it]    detect and localize:  24%|██▍       | 238/1000 [02:33<14:41,  1.16s/it]    detect and localize:  24%|██▍       | 239/1000 [02:33<13:18,  1.05s/it]    detect and localize:  24%|██▍       | 241/1000 [02:35<12:04,  1.05it/s]    detect and localize:  24%|██▍       | 243/1000 [02:35<09:32,  1.32it/s]    detect and localize:  24%|██▍       | 244/1000 [02:36<10:10,  1.24it/s]    detect and localize:  25%|██▍       | 247/1000 [02:37<06:42,  1.87it/s]    detect and localize:  25%|██▌       | 252/1000 [02:38<05:18,  2.35it/s]    detect and localize:  26%|██▌       | 260/1000 [02:39<03:19,  3.70it/s]    detect and localize:  27%|██▋       | 266/1000 [02:40<02:48,  4.36it/s]    detect and localize:  27%|██▋       | 274/1000 [02:41<01:53,  6.41it/s]    detect and localize:  28%|██▊       | 275/1000 [03:01<18:17,  1.51s/it]    detect and localize:  28%|██▊       | 276/1000 [03:02<18:07,  1.50s/it]    detect and localize:  28%|██▊       | 281/1000 [03:03<11:21,  1.05it/s]    detect and localize:  28%|██▊       | 284/1000 [03:04<09:52,  1.21it/s]    detect and localize:  29%|██▊       | 286/1000 [03:05<09:08,  1.30it/s]    detect and localize:  29%|██▉       | 290/1000 [03:06<06:57,  1.70it/s]    detect and localize:  29%|██▉       | 292/1000 [03:06<05:41,  2.07it/s]    detect and localize:  29%|██▉       | 294/1000 [03:07<05:50,  2.01it/s]    detect and localize:  30%|██▉       | 298/1000 [03:08<04:31,  2.59it/s]    detect and localize:  30%|███       | 300/1000 [03:10<05:35,  2.08it/s]    detect and localize:  31%|███       | 312/1000 [03:11<02:49,  4.07it/s]    detect and localize:  32%|███▏      | 315/1000 [03:31<16:10,  1.42s/it]    detect and localize:  32%|███▏      | 316/1000 [03:31<15:00,  1.32s/it]    detect and localize:  32%|███▏      | 317/1000 [03:31<14:00,  1.23s/it]    detect and localize:  32%|███▏      | 320/1000 [03:33<11:07,  1.02it/s]    detect and localize:  32%|███▏      | 321/1000 [03:33<10:02,  1.13it/s]    detect and localize:  32%|███▎      | 325/1000 [03:34<07:22,  1.52it/s]    detect and localize:  33%|███▎      | 326/1000 [03:34<06:34,  1.71it/s]    detect and localize:  33%|███▎      | 333/1000 [03:35<03:36,  3.08it/s]    detect and localize:  34%|███▎      | 336/1000 [03:35<02:55,  3.79it/s]    detect and localize:  34%|███▍      | 339/1000 [03:37<03:46,  2.92it/s]    detect and localize:  34%|███▍      | 343/1000 [03:37<02:44,  3.99it/s]    detect and localize:  35%|███▌      | 350/1000 [03:39<02:46,  3.91it/s]    detect and localize:  35%|███▌      | 354/1000 [03:39<02:12,  4.89it/s]    detect and localize:  36%|███▌      | 355/1000 [03:58<19:57,  1.86s/it]    detect and localize:  36%|███▌      | 357/1000 [04:00<17:20,  1.62s/it]    detect and localize:  36%|███▌      | 360/1000 [04:00<12:17,  1.15s/it]    detect and localize:  36%|███▌      | 361/1000 [04:00<11:14,  1.06s/it]    detect and localize:  36%|███▋      | 364/1000 [04:01<08:27,  1.25it/s]    detect and localize:  37%|███▋      | 367/1000 [04:02<06:46,  1.56it/s]    detect and localize:  37%|███▋      | 369/1000 [04:03<05:41,  1.85it/s]    detect and localize:  38%|███▊      | 384/1000 [04:04<02:01,  5.08it/s]    detect and localize:  38%|███▊      | 385/1000 [04:05<02:59,  3.43it/s]    detect and localize:  39%|███▉      | 393/1000 [04:07<02:39,  3.80it/s]    detect and localize:  40%|███▉      | 395/1000 [04:27<15:18,  1.52s/it]    detect and localize:  40%|███▉      | 396/1000 [04:27<14:28,  1.44s/it]    detect and localize:  40%|███▉      | 398/1000 [04:28<12:12,  1.22s/it]    detect and localize:  40%|███▉      | 399/1000 [04:28<10:55,  1.09s/it]    detect and localize:  40%|████      | 400/1000 [04:28<09:41,  1.03it/s]    detect and localize:  40%|████      | 403/1000 [04:29<06:22,  1.56it/s]    detect and localize:  40%|████      | 404/1000 [04:30<06:39,  1.49it/s]    detect and localize:  41%|████      | 410/1000 [04:30<03:07,  3.14it/s]    detect and localize:  41%|████      | 412/1000 [04:31<03:49,  2.56it/s]    detect and localize:  41%|████▏     | 414/1000 [04:32<03:36,  2.70it/s]    detect and localize:  42%|████▏     | 415/1000 [04:33<04:55,  1.98it/s]    detect and localize:  43%|████▎     | 433/1000 [04:34<01:23,  6.76it/s]    detect and localize:  44%|████▎     | 435/1000 [04:54<11:28,  1.22s/it]    detect and localize:  44%|████▎     | 437/1000 [04:56<11:07,  1.18s/it]    detect and localize:  44%|████▍     | 444/1000 [04:56<06:44,  1.37it/s]    detect and localize:  44%|████▍     | 445/1000 [04:57<06:48,  1.36it/s]    detect and localize:  45%|████▌     | 450/1000 [04:58<05:00,  1.83it/s]    detect and localize:  45%|████▌     | 452/1000 [05:00<05:55,  1.54it/s]    detect and localize:  46%|████▌     | 462/1000 [05:01<02:48,  3.19it/s]    detect and localize:  46%|████▋     | 464/1000 [05:01<02:43,  3.28it/s]    detect and localize:  47%|████▋     | 466/1000 [05:01<02:25,  3.67it/s]    detect and localize:  47%|████▋     | 472/1000 [05:01<01:28,  5.95it/s]    detect and localize:  47%|████▋     | 472/1000 [05:20<01:28,  5.95it/s]    detect and localize:  48%|████▊     | 475/1000 [05:21<14:19,  1.64s/it]    detect and localize:  48%|████▊     | 479/1000 [05:22<10:02,  1.16s/it]    detect and localize:  48%|████▊     | 482/1000 [05:24<09:26,  1.09s/it]    detect and localize:  48%|████▊     | 485/1000 [05:24<07:09,  1.20it/s]    detect and localize:  49%|████▉     | 488/1000 [05:25<05:52,  1.45it/s]    detect and localize:  49%|████▉     | 492/1000 [05:26<04:09,  2.04it/s]    detect and localize:  49%|████▉     | 494/1000 [05:28<04:52,  1.73it/s]    detect and localize:  50%|████▉     | 497/1000 [05:28<03:41,  2.27it/s]    detect and localize:  50%|████▉     | 498/1000 [05:28<03:44,  2.24it/s]    detect and localize:  50%|█████     | 501/1000 [05:30<03:37,  2.29it/s]    detect and localize:  50%|█████     | 502/1000 [05:30<03:20,  2.49it/s]    detect and localize:  50%|█████     | 504/1000 [05:30<02:38,  3.13it/s]    detect and localize:  51%|█████     | 507/1000 [05:30<01:44,  4.70it/s]    detect and localize:  51%|█████     | 509/1000 [05:31<01:52,  4.35it/s]    detect and localize:  51%|█████     | 512/1000 [05:32<02:05,  3.88it/s]    detect and localize:  52%|█████▏    | 515/1000 [05:51<19:18,  2.39s/it]    detect and localize:  52%|█████▏    | 517/1000 [05:51<14:36,  1.82s/it]    detect and localize:  52%|█████▏    | 519/1000 [05:52<11:44,  1.46s/it]    detect and localize:  52%|█████▏    | 521/1000 [05:53<09:00,  1.13s/it]    detect and localize:  52%|█████▏    | 522/1000 [05:53<08:24,  1.05s/it]    detect and localize:  52%|█████▎    | 525/1000 [05:54<05:57,  1.33it/s]    detect and localize:  53%|█████▎    | 533/1000 [05:55<02:40,  2.90it/s]    detect and localize:  54%|█████▎    | 536/1000 [05:57<03:21,  2.30it/s]    detect and localize:  54%|█████▍    | 541/1000 [05:58<02:26,  3.13it/s]    detect and localize:  54%|█████▍    | 543/1000 [05:58<02:21,  3.22it/s]    detect and localize:  55%|█████▍    | 547/1000 [05:59<02:13,  3.40it/s]    detect and localize:  55%|█████▌    | 554/1000 [06:00<01:25,  5.23it/s]    detect and localize:  56%|█████▌    | 555/1000 [06:18<12:36,  1.70s/it]    detect and localize:  56%|█████▌    | 556/1000 [06:19<12:29,  1.69s/it]    detect and localize:  56%|█████▌    | 559/1000 [06:20<08:54,  1.21s/it]    detect and localize:  56%|█████▋    | 564/1000 [06:21<05:23,  1.35it/s]    detect and localize:  57%|█████▋    | 567/1000 [06:21<04:07,  1.75it/s]    detect and localize:  57%|█████▋    | 568/1000 [06:22<04:26,  1.62it/s]    detect and localize:  57%|█████▋    | 570/1000 [06:23<04:12,  1.70it/s]    detect and localize:  57%|█████▋    | 573/1000 [06:23<03:06,  2.29it/s]    detect and localize:  58%|█████▊    | 582/1000 [06:24<01:30,  4.62it/s]    detect and localize:  58%|█████▊    | 584/1000 [06:25<01:58,  3.51it/s]    detect and localize:  59%|█████▊    | 587/1000 [06:25<01:38,  4.18it/s]    detect and localize:  59%|█████▉    | 592/1000 [06:27<01:37,  4.19it/s]    detect and localize:  59%|█████▉    | 593/1000 [06:27<01:31,  4.43it/s]    detect and localize:  59%|█████▉    | 594/1000 [06:27<01:42,  3.96it/s]    detect and localize:  60%|█████▉    | 595/1000 [06:45<19:19,  2.86s/it]    detect and localize:  60%|█████▉    | 596/1000 [06:45<16:04,  2.39s/it]    detect and localize:  60%|█████▉    | 597/1000 [06:46<13:49,  2.06s/it]    detect and localize:  60%|█████▉    | 598/1000 [06:47<11:32,  1.72s/it]    detect and localize:  60%|█████▉    | 599/1000 [06:48<10:29,  1.57s/it]    detect and localize:  60%|██████    | 600/1000 [06:48<09:00,  1.35s/it]    detect and localize:  60%|██████    | 602/1000 [06:49<06:49,  1.03s/it]    detect and localize:  60%|██████    | 604/1000 [06:50<04:30,  1.46it/s]    detect and localize:  61%|██████    | 606/1000 [06:50<03:26,  1.91it/s]    detect and localize:  61%|██████    | 610/1000 [06:51<02:04,  3.13it/s]    detect and localize:  61%|██████    | 611/1000 [06:51<01:56,  3.34it/s]    detect and localize:  62%|██████▏   | 616/1000 [06:52<01:43,  3.72it/s]    detect and localize:  62%|██████▏   | 617/1000 [06:52<01:36,  3.98it/s]    detect and localize:  62%|██████▏   | 619/1000 [06:53<01:43,  3.68it/s]    detect and localize:  63%|██████▎   | 632/1000 [06:53<00:36, 10.21it/s]    detect and localize:  63%|██████▎   | 634/1000 [06:55<01:15,  4.86it/s]    detect and localize:  63%|██████▎   | 634/1000 [07:10<01:15,  4.86it/s]    detect and localize:  64%|██████▎   | 635/1000 [07:11<09:46,  1.61s/it]    detect and localize:  64%|██████▎   | 636/1000 [07:12<09:23,  1.55s/it]    detect and localize:  64%|██████▍   | 638/1000 [07:13<07:41,  1.28s/it]    detect and localize:  64%|██████▍   | 640/1000 [07:13<05:51,  1.02it/s]    detect and localize:  64%|██████▍   | 641/1000 [07:14<05:21,  1.12it/s]    detect and localize:  64%|██████▍   | 642/1000 [07:15<05:56,  1.00it/s]    detect and localize:  65%|██████▍   | 648/1000 [07:17<03:19,  1.76it/s]    detect and localize:  65%|██████▍   | 649/1000 [07:17<02:59,  1.96it/s]    detect and localize:  65%|██████▌   | 650/1000 [07:18<03:50,  1.52it/s]    detect and localize:  65%|██████▌   | 654/1000 [07:19<02:09,  2.68it/s]    detect and localize:  66%|██████▌   | 658/1000 [07:19<01:21,  4.18it/s]    detect and localize:  66%|██████▌   | 662/1000 [07:20<01:32,  3.64it/s]    detect and localize:  66%|██████▋   | 664/1000 [07:21<01:39,  3.37it/s]    detect and localize:  66%|██████▋   | 665/1000 [07:22<02:11,  2.55it/s]    detect and localize:  67%|██████▋   | 674/1000 [07:23<01:07,  4.80it/s]    detect and localize:  68%|██████▊   | 675/1000 [07:41<10:03,  1.86s/it]    detect and localize:  68%|██████▊   | 676/1000 [07:42<09:00,  1.67s/it]    detect and localize:  68%|██████▊   | 677/1000 [07:45<09:59,  1.85s/it]    detect and localize:  68%|██████▊   | 680/1000 [07:48<08:36,  1.61s/it]    detect and localize:  68%|██████▊   | 682/1000 [07:48<06:23,  1.21s/it]    detect and localize:  68%|██████▊   | 683/1000 [07:50<07:02,  1.33s/it]    detect and localize:  68%|██████▊   | 685/1000 [07:52<05:50,  1.11s/it]    detect and localize:  69%|██████▉   | 688/1000 [07:52<03:59,  1.30it/s]    detect and localize:  69%|██████▉   | 689/1000 [07:56<06:11,  1.20s/it]    detect and localize:  69%|██████▉   | 690/1000 [07:57<06:05,  1.18s/it]    detect and localize:  69%|██████▉   | 692/1000 [07:58<05:07,  1.00it/s]    detect and localize:  70%|██████▉   | 695/1000 [08:01<04:47,  1.06it/s]    detect and localize:  70%|██████▉   | 696/1000 [08:01<04:17,  1.18it/s]    detect and localize:  70%|██████▉   | 699/1000 [08:02<03:10,  1.58it/s]    detect and localize:  70%|███████   | 705/1000 [08:03<01:38,  3.00it/s]    detect and localize:  71%|███████   | 706/1000 [08:03<01:30,  3.26it/s]    detect and localize:  71%|███████   | 707/1000 [08:05<03:03,  1.60it/s]    detect and localize:  71%|███████   | 708/1000 [08:07<03:41,  1.32it/s]    detect and localize:  72%|███████▏  | 715/1000 [08:38<14:36,  3.08s/it]    detect and localize:  72%|███████▏  | 716/1000 [08:41<14:40,  3.10s/it]    detect and localize:  72%|███████▏  | 717/1000 [08:43<14:00,  2.97s/it]    detect and localize:  72%|███████▏  | 718/1000 [08:44<12:24,  2.64s/it]    detect and localize:  72%|███████▏  | 720/1000 [08:45<08:55,  1.91s/it]    detect and localize:  72%|███████▏  | 721/1000 [08:48<10:04,  2.17s/it]    detect and localize:  72%|███████▏  | 724/1000 [08:49<05:55,  1.29s/it]    detect and localize:  72%|███████▎  | 725/1000 [08:49<05:00,  1.09s/it]    detect and localize:  73%|███████▎  | 726/1000 [08:52<06:32,  1.43s/it]    detect and localize:  73%|███████▎  | 731/1000 [08:52<02:50,  1.58it/s]    detect and localize:  73%|███████▎  | 732/1000 [08:55<03:52,  1.15it/s]    detect and localize:  73%|███████▎  | 733/1000 [08:57<04:40,  1.05s/it]    detect and localize:  74%|███████▍  | 738/1000 [08:57<02:27,  1.78it/s]    detect and localize:  74%|███████▍  | 740/1000 [08:58<02:04,  2.09it/s]    detect and localize:  75%|███████▍  | 749/1000 [08:59<01:03,  3.96it/s]    detect and localize:  75%|███████▌  | 751/1000 [08:59<01:06,  3.75it/s]    detect and localize:  75%|███████▌  | 752/1000 [09:01<01:36,  2.58it/s]    detect and localize:  75%|███████▌  | 753/1000 [09:04<02:59,  1.37it/s]    detect and localize:  75%|███████▌  | 754/1000 [09:05<02:58,  1.38it/s]    detect and localize:  76%|███████▌  | 755/1000 [09:31<21:54,  5.37s/it]    detect and localize:  76%|███████▌  | 756/1000 [09:37<22:26,  5.52s/it]    detect and localize:  76%|███████▌  | 757/1000 [09:37<17:33,  4.33s/it]    detect and localize:  76%|███████▌  | 758/1000 [09:38<13:37,  3.38s/it]    detect and localize:  76%|███████▌  | 759/1000 [09:39<10:58,  2.73s/it]    detect and localize:  76%|███████▌  | 760/1000 [09:40<09:24,  2.35s/it]    detect and localize:  76%|███████▌  | 761/1000 [09:44<11:14,  2.82s/it]    detect and localize:  77%|███████▋  | 767/1000 [09:46<04:18,  1.11s/it]    detect and localize:  77%|███████▋  | 771/1000 [09:48<03:04,  1.24it/s]    detect and localize:  78%|███████▊  | 779/1000 [09:48<01:27,  2.51it/s]    detect and localize:  78%|███████▊  | 780/1000 [09:49<01:34,  2.32it/s]    detect and localize:  78%|███████▊  | 781/1000 [09:50<02:00,  1.82it/s]    detect and localize:  78%|███████▊  | 784/1000 [09:52<01:48,  1.98it/s]    detect and localize:  79%|███████▉  | 789/1000 [09:53<01:23,  2.53it/s]    detect and localize:  79%|███████▉  | 792/1000 [09:55<01:42,  2.02it/s]    detect and localize:  79%|███████▉  | 793/1000 [09:56<01:54,  1.80it/s]    detect and localize:  79%|███████▉  | 794/1000 [09:57<02:07,  1.62it/s]    detect and localize:  80%|███████▉  | 795/1000 [10:26<18:28,  5.41s/it]    detect and localize:  80%|███████▉  | 796/1000 [10:31<17:51,  5.25s/it]    detect and localize:  80%|███████▉  | 798/1000 [10:32<12:06,  3.60s/it]    detect and localize:  80%|███████▉  | 799/1000 [10:34<10:31,  3.14s/it]    detect and localize:  80%|████████  | 800/1000 [10:36<09:58,  2.99s/it]    detect and localize:  80%|████████  | 801/1000 [10:38<08:51,  2.67s/it]    detect and localize:  80%|████████  | 802/1000 [10:38<07:05,  2.15s/it]    detect and localize:  80%|████████  | 804/1000 [10:39<04:35,  1.41s/it]    detect and localize:  81%|████████  | 806/1000 [10:43<05:13,  1.61s/it]    detect and localize:  81%|████████  | 810/1000 [10:44<02:47,  1.14it/s]    detect and localize:  82%|████████▏ | 815/1000 [10:46<01:55,  1.61it/s]    detect and localize:  82%|████████▏ | 819/1000 [10:47<01:31,  1.97it/s]    detect and localize:  83%|████████▎ | 826/1000 [10:47<00:48,  3.61it/s]    detect and localize:  83%|████████▎ | 833/1000 [10:47<00:33,  5.06it/s]    detect and localize:  83%|████████▎ | 833/1000 [11:01<00:33,  5.06it/s]    detect and localize:  84%|████████▎ | 835/1000 [11:21<07:01,  2.56s/it]    detect and localize:  84%|████████▎ | 836/1000 [11:25<07:21,  2.69s/it]    detect and localize:  84%|████████▍ | 839/1000 [11:27<05:30,  2.05s/it]    detect and localize:  84%|████████▍ | 840/1000 [11:27<04:57,  1.86s/it]    detect and localize:  84%|████████▍ | 841/1000 [11:28<04:24,  1.66s/it]    detect and localize:  84%|████████▍ | 842/1000 [11:30<04:35,  1.74s/it]    detect and localize:  84%|████████▍ | 843/1000 [11:32<04:54,  1.88s/it]    detect and localize:  85%|████████▍ | 846/1000 [11:33<03:05,  1.20s/it]    detect and localize:  85%|████████▍ | 848/1000 [11:35<02:37,  1.04s/it]    detect and localize:  85%|████████▌ | 851/1000 [11:36<02:07,  1.17it/s]    detect and localize:  85%|████████▌ | 853/1000 [11:38<02:04,  1.19it/s]    detect and localize:  85%|████████▌ | 854/1000 [11:39<02:10,  1.12it/s]    detect and localize:  86%|████████▌ | 860/1000 [11:40<01:07,  2.07it/s]    detect and localize:  86%|████████▋ | 864/1000 [11:42<00:57,  2.37it/s]    detect and localize:  86%|████████▋ | 865/1000 [11:43<01:20,  1.68it/s]    detect and localize:  87%|████████▋ | 866/1000 [11:44<01:18,  1.71it/s]    detect and localize:  88%|████████▊ | 875/1000 [12:15<05:04,  2.44s/it]    detect and localize:  88%|████████▊ | 877/1000 [12:17<04:29,  2.19s/it]    detect and localize:  88%|████████▊ | 878/1000 [12:17<03:59,  1.96s/it]    detect and localize:  88%|████████▊ | 879/1000 [12:21<04:26,  2.21s/it]    detect and localize:  88%|████████▊ | 882/1000 [12:26<03:57,  2.01s/it]    detect and localize:  88%|████████▊ | 885/1000 [12:28<02:54,  1.52s/it]    detect and localize:  89%|████████▊ | 887/1000 [12:30<02:38,  1.40s/it]    detect and localize:  89%|████████▉ | 889/1000 [12:31<02:08,  1.15s/it]    detect and localize:  89%|████████▉ | 891/1000 [12:32<01:55,  1.06s/it]    detect and localize:  89%|████████▉ | 893/1000 [12:34<01:39,  1.07it/s]    detect and localize:  90%|████████▉ | 895/1000 [12:36<01:38,  1.07it/s]    detect and localize:  90%|█████████ | 901/1000 [12:36<00:47,  2.08it/s]    detect and localize:  90%|█████████ | 902/1000 [12:38<00:58,  1.67it/s]    detect and localize:  90%|█████████ | 903/1000 [12:38<00:56,  1.72it/s]    detect and localize:  90%|█████████ | 905/1000 [12:41<01:24,  1.13it/s]    detect and localize:  91%|█████████ | 909/1000 [12:42<00:46,  1.95it/s]    detect and localize:  91%|█████████▏| 913/1000 [12:42<00:31,  2.79it/s]    detect and localize:  91%|█████████▏| 914/1000 [12:44<00:51,  1.69it/s]    detect and localize:  92%|█████████▏| 915/1000 [13:15<07:08,  5.04s/it]    detect and localize:  92%|█████████▏| 917/1000 [13:16<05:03,  3.66s/it]    detect and localize:  92%|█████████▏| 919/1000 [13:18<04:00,  2.97s/it]    detect and localize:  92%|█████████▏| 921/1000 [13:20<03:04,  2.33s/it]    detect and localize:  92%|█████████▏| 922/1000 [13:23<03:12,  2.47s/it]    detect and localize:  92%|█████████▏| 923/1000 [13:24<02:39,  2.07s/it]    detect and localize:  92%|█████████▏| 924/1000 [13:26<02:48,  2.22s/it]    detect and localize:  93%|█████████▎| 928/1000 [13:27<01:18,  1.10s/it]    detect and localize:  93%|█████████▎| 929/1000 [13:27<01:08,  1.04it/s]    detect and localize:  93%|█████████▎| 931/1000 [13:28<00:51,  1.34it/s]    detect and localize:  93%|█████████▎| 932/1000 [13:28<00:44,  1.52it/s]    detect and localize:  93%|█████████▎| 933/1000 [13:30<00:57,  1.17it/s]    detect and localize:  94%|█████████▎| 937/1000 [13:30<00:27,  2.31it/s]    detect and localize:  94%|█████████▍| 938/1000 [13:33<00:46,  1.34it/s]    detect and localize:  95%|█████████▍| 946/1000 [13:35<00:22,  2.42it/s]    detect and localize:  95%|█████████▌| 950/1000 [13:36<00:20,  2.44it/s]    detect and localize:  95%|█████████▌| 953/1000 [13:37<00:17,  2.73it/s]    detect and localize:  95%|█████████▌| 954/1000 [13:41<00:36,  1.25it/s]    detect and localize:  96%|█████████▌| 955/1000 [14:08<03:10,  4.24s/it]    detect and localize:  96%|█████████▌| 956/1000 [14:09<02:42,  3.70s/it]    detect and localize:  96%|█████████▌| 957/1000 [14:12<02:37,  3.65s/it]    detect and localize:  96%|█████████▌| 961/1000 [14:14<01:18,  2.02s/it]    detect and localize:  96%|█████████▌| 962/1000 [14:16<01:15,  1.98s/it]    detect and localize:  96%|█████████▋| 963/1000 [14:18<01:15,  2.05s/it]    detect and localize:  97%|█████████▋| 966/1000 [14:19<00:44,  1.31s/it]    detect and localize:  97%|█████████▋| 967/1000 [14:19<00:36,  1.10s/it]    detect and localize:  97%|█████████▋| 968/1000 [14:20<00:30,  1.06it/s]    detect and localize:  97%|█████████▋| 970/1000 [14:21<00:25,  1.18it/s]    detect and localize:  97%|█████████▋| 973/1000 [14:21<00:13,  2.01it/s]    detect and localize:  98%|█████████▊| 983/1000 [14:22<00:03,  4.78it/s]    detect and localize:  99%|█████████▊| 987/1000 [14:22<00:02,  5.35it/s]    detect and localize:  99%|█████████▉| 993/1000 [14:23<00:00,  7.07it/s]    detect and localize: 100%|█████████▉| 995/1000 [14:28<00:02,  1.98it/s]    detect and localize: 100%|█████████▉| 997/1000 [14:28<00:01,  2.31it/s]    detect and localize: 100%|█████████▉| 998/1000 [14:28<00:00,  2.30it/s]    detect and localize: 100%|██████████| 1000/1000 [14:29<00:00,  1.15it/s]




.. GENERATED FROM PYTHON SOURCE LINES 101-126

Plot the results
----------------

We load back the results and use the widgets module to explore the estimated drift motion.

For all methods we have 4 plots:
  * **top left:** time vs estimated peak depth
  * **top right:** time vs peak depth after motion correction
  * **bottom left:** the average motion vector across depths and all motion across spatial depths for non-rigid estimation)
  * **bottom right:** if motion correction is non rigid, the motion vector across depths is plotted as a map, with the color code representing the motion in micrometers.

A few comments on the figures:
  * The preset **'rigid_fast'** has only one motion vector for the entire probe because it is a "rigid" case.
    The motion amplitude is globally underestimated because it averages across depths.
    However, the corrected peaks are flatter than the non-corrected ones, so the job is partially done.
    The big jump at=600s when the probe start moving is recovered quite well.
  * The preset **kilosort_like** gives better results because it is a non-rigid case.
    The motion vector is computed for different depths.
    The corrected peak locations are flatter than the rigid case.
    The motion vector map is still be a bit noisy at some depths (e.g around 1000um).
  * The preset **nonrigid_accurate** seems to give the best results on this recording.
    The motion vector seems less noisy globally, but it is not "perfect" (see at the top of the probe 3200um to 3800um).
    Also note that in the first part of the recording before the imposed motion (0-600s) we clearly have a non-rigid motion:
    the upper part of the probe (2000-3000um) experience some drifts, but the lower part (0-1000um) is relatively stable.
    The method defined by this preset is able to capture this.

.. GENERATED FROM PYTHON SOURCE LINES 126-139

.. code-block:: Python


    for preset in some_presets:
        fig = plt.figure(figsize=(14, 8))
        si.plot_motion(
            results[preset]["motion_info"],
            figure=fig,
            depth_lim=(400, 600),
            color_amplitude=True,
            amplitude_cmap="inferno",
            scatter_decimate=10,
        )
        fig.suptitle(f"{preset=}")




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_001.png
         :alt: preset='rigid_fast', Peak depth, Corrected peak depth, Motion vectors
         :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_001.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_002.png
         :alt: preset='kilosort_like', Peak depth, Corrected peak depth, Motion vectors, Motion vectors
         :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_003.png
         :alt: preset='nonrigid_accurate', Peak depth, Corrected peak depth, Motion vectors, Motion vectors
         :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_003.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 140-158

Plot peak localization
----------------------

We can also use the internal extra results (peaks and peaks location) to check if putative
clusters have a lower spatial spread after the motion correction.

Here we plot the estimated peak locations (left) and the corrected peak locations
(on right) on top of the probe.
The color codes for the peak amplitudes.

We can see here that some clusters seem to be more compact on the 'y' axis, especially
for the preset "nonrigid_accurate".

Be aware that there are two ways to correct for the motion:
  1. Interpolate traces and detect/localize peaks again  (`interpolate_recording()`)
  2. Compensate for drifts directly on peak locations (`correct_motion_on_peaks()`)

Case 1 is used before running a spike sorter and the case 2 is used here to display the results.

.. GENERATED FROM PYTHON SOURCE LINES 158-202

.. code-block:: Python


    from spikeinterface.sortingcomponents.motion_interpolation import correct_motion_on_peaks

    for preset in some_presets:

        fig, axs = plt.subplots(ncols=2, figsize=(12, 8), sharey=True)

        ax = axs[0]
        si.plot_probe_map(rec, ax=ax)

        motion_info = results[preset]["motion_info"]

        peaks = motion_info["peaks"]
        sr = rec.get_sampling_frequency()
        time_lim0 = 0
        time_lim1 = 50
        mask = (peaks["sample_index"] > int(sr * time_lim0)) & (peaks["sample_index"] < int(sr * time_lim1))
        sl = slice(None, None, 5)
        amps = np.abs(peaks["amplitude"][mask][sl])
        amps /= np.quantile(amps, 0.95)
        c = plt.get_cmap("inferno")(amps)

        color_kargs = dict(alpha=0.2, s=2, c=c)

        loc = motion_info["peak_locations"]
        ax.scatter(loc["x"][mask][sl], loc["y"][mask][sl], **color_kargs)

        loc2 = correct_motion_on_peaks(
            motion_info["peaks"],
            motion_info["peak_locations"],
            rec.sampling_frequency,
            motion_info["motion"],
            motion_info["temporal_bins"],
            motion_info["spatial_bins"],
            direction="y",
        )

        ax = axs[1]
        si.plot_probe_map(rec, ax=ax)
        ax.scatter(loc2["x"][mask][sl], loc2["y"][mask][sl], **color_kargs)

        ax.set_ylim(400, 600)
        fig.suptitle(f"{preset=}")




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_004.png
         :alt: preset='rigid_fast'
         :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_004.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_005.png
         :alt: preset='kilosort_like'
         :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_005.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_006.png
         :alt: preset='nonrigid_accurate'
         :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_006.png
         :class: sphx-glr-multi-img





.. GENERATED FROM PYTHON SOURCE LINES 203-208

Accuracy and Run Times
----------------------

Presets and related methods have differents accuracies but also computation speeds.
It is good to have this in mind!

.. GENERATED FROM PYTHON SOURCE LINES 208-222

.. code-block:: Python


    run_times = []
    for preset in some_presets:
        run_times.append(results[preset]["motion_info"]["run_times"])
    keys = run_times[0].keys()

    bottom = np.zeros(len(run_times))
    fig, ax = plt.subplots()
    for k in keys:
        rtimes = np.array([rt[k] for rt in run_times])
        if np.any(rtimes > 0.0):
            ax.bar(some_presets, rtimes, bottom=bottom, label=k)
        bottom += rtimes
    ax.legend()



.. image-sg:: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_007.png
   :alt: plot handle drift
   :srcset: /long_tutorials/handle_drift/images/sphx_glr_plot_handle_drift_007.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    <matplotlib.legend.Legend object at 0x28f112f80>




.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (42 minutes 27.561 seconds)


.. _sphx_glr_download_long_tutorials_handle_drift_plot_handle_drift.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_handle_drift.ipynb <plot_handle_drift.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_handle_drift.py <plot_handle_drift.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
